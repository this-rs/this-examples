<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>this-rs WebSocket Client</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e0e0e0; padding: 20px; }
        h1 { color: #00d4ff; margin-bottom: 20px; font-size: 1.5em; }
        h2 { color: #ccc; font-size: 1.1em; margin-bottom: 10px; }

        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .panel { background: #16213e; border-radius: 8px; padding: 20px; border: 1px solid #0f3460; }

        /* Connection */
        .status { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-dot.connected { background: #00e676; box-shadow: 0 0 8px #00e676; }
        .status-dot.disconnected { background: #ff1744; }
        .status-dot.connecting { background: #ffab00; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

        input, select, button { padding: 8px 12px; border-radius: 4px; border: 1px solid #0f3460; background: #0a0a23; color: #e0e0e0; font-size: 0.9em; width: 100%; }
        input:focus, select:focus { outline: none; border-color: #00d4ff; }
        button { cursor: pointer; background: #0f3460; border-color: #00d4ff; color: #00d4ff; font-weight: bold; transition: all 0.2s; }
        button:hover { background: #00d4ff; color: #0a0a23; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        button.danger { border-color: #ff1744; color: #ff1744; }
        button.danger:hover { background: #ff1744; color: white; }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.8em; color: #888; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Subscriptions list */
        .subscription-item { display: flex; justify-content: space-between; align-items: center; background: #0a0a23; padding: 8px 12px; border-radius: 4px; margin-bottom: 6px; font-size: 0.85em; }
        .subscription-item .filter-info { color: #00d4ff; }
        .subscription-item button { width: auto; padding: 4px 10px; font-size: 0.8em; }

        /* Event log */
        #event-log { height: 500px; overflow-y: auto; font-family: 'Fira Code', 'Consolas', monospace; font-size: 0.82em; padding: 10px; background: #0a0a23; border-radius: 4px; border: 1px solid #0f3460; }
        .log-entry { padding: 6px 0; border-bottom: 1px solid #16213e; }
        .log-entry .timestamp { color: #666; font-size: 0.85em; }
        .log-entry.event { color: #00e676; }
        .log-entry.subscribed { color: #00d4ff; }
        .log-entry.unsubscribed { color: #ffab00; }
        .log-entry.welcome { color: #e040fb; }
        .log-entry.error { color: #ff1744; }
        .log-entry.pong { color: #666; }
        .log-entry.system { color: #888; font-style: italic; }

        .log-controls { display: flex; gap: 8px; margin-bottom: 10px; }
        .log-controls button { width: auto; }
        .event-count { color: #888; font-size: 0.85em; }
        pre { white-space: pre-wrap; word-break: break-all; margin-top: 4px; color: #aaa; }
    </style>
</head>
<body>
    <h1>this-rs WebSocket Client</h1>
    <div class="container">
        <!-- Left panel: Controls -->
        <div>
            <!-- Connection -->
            <div class="panel" style="margin-bottom: 20px;">
                <h2>Connection</h2>
                <div class="status">
                    <div class="status-dot disconnected" id="status-dot"></div>
                    <span id="status-text">Disconnected</span>
                </div>
                <div class="form-group">
                    <label>Server URL</label>
                    <input type="text" id="ws-url" value="ws://127.0.0.1:4243/ws">
                </div>
                <button id="btn-connect" onclick="toggleConnection()">Connect</button>
            </div>

            <!-- Subscribe -->
            <div class="panel" style="margin-bottom: 20px;">
                <h2>Subscribe</h2>
                <div class="form-group">
                    <label>Entity Type (optional)</label>
                    <select id="filter-entity-type">
                        <option value="">* (all)</option>
                        <option value="order">order</option>
                        <option value="invoice">invoice</option>
                        <option value="payment">payment</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Event Type (optional)</label>
                    <select id="filter-event-type">
                        <option value="">* (all)</option>
                        <option value="created">created</option>
                        <option value="updated">updated</option>
                        <option value="deleted">deleted</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Kind (optional)</label>
                    <select id="filter-kind">
                        <option value="">* (all)</option>
                        <option value="entity">entity</option>
                        <option value="link">link</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Entity ID (optional, UUID)</label>
                    <input type="text" id="filter-entity-id" placeholder="e.g. 550e8400-e29b-41d4-...">
                </div>
                <button id="btn-subscribe" onclick="subscribe()" disabled>Subscribe</button>
            </div>

            <!-- Active subscriptions -->
            <div class="panel">
                <h2>Active Subscriptions <span class="event-count" id="sub-count">(0)</span></h2>
                <div id="subscriptions-list"></div>
                <button onclick="sendPing()" style="margin-top: 10px;" disabled id="btn-ping">Ping</button>
            </div>
        </div>

        <!-- Right panel: Event log -->
        <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>Event Log <span class="event-count" id="event-count">(0 events)</span></h2>
                <div class="log-controls">
                    <button onclick="clearLog()">Clear</button>
                </div>
            </div>
            <div id="event-log"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let subscriptions = {};
        let eventCount = 0;

        function toggleConnection() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            } else {
                connect();
            }
        }

        function connect() {
            const url = document.getElementById('ws-url').value;
            setStatus('connecting');

            ws = new WebSocket(url);

            ws.onopen = () => {
                setStatus('connected');
                document.getElementById('btn-subscribe').disabled = false;
                document.getElementById('btn-ping').disabled = false;
                logSystem('Connected to ' + url);
            };

            ws.onclose = (e) => {
                setStatus('disconnected');
                document.getElementById('btn-subscribe').disabled = true;
                document.getElementById('btn-ping').disabled = true;
                subscriptions = {};
                renderSubscriptions();
                logSystem('Disconnected (code: ' + e.code + ')');
            };

            ws.onerror = () => {
                logEntry('error', 'Connection error');
            };

            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                handleMessage(msg);
            };
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'welcome':
                    logEntry('welcome', 'Welcome! Connection ID: ' + msg.connection_id);
                    break;
                case 'subscribed':
                    subscriptions[msg.subscription_id] = msg.filter;
                    renderSubscriptions();
                    logEntry('subscribed', 'Subscribed: ' + msg.subscription_id + ' ' + formatFilter(msg.filter));
                    break;
                case 'unsubscribed':
                    delete subscriptions[msg.subscription_id];
                    renderSubscriptions();
                    logEntry('unsubscribed', 'Unsubscribed: ' + msg.subscription_id);
                    break;
                case 'event':
                    eventCount++;
                    document.getElementById('event-count').textContent = '(' + eventCount + ' events)';
                    logEntry('event', 'Event [' + msg.subscription_id + ']', msg.data);
                    break;
                case 'pong':
                    logEntry('pong', 'Pong');
                    break;
                case 'error':
                    logEntry('error', 'Error: ' + msg.message);
                    break;
                default:
                    logEntry('system', 'Unknown message type: ' + msg.type);
            }
        }

        function subscribe() {
            const filter = {};
            const entityType = document.getElementById('filter-entity-type').value;
            const eventType = document.getElementById('filter-event-type').value;
            const kind = document.getElementById('filter-kind').value;
            const entityId = document.getElementById('filter-entity-id').value.trim();

            if (entityType) filter.entity_type = entityType;
            if (eventType) filter.event_type = eventType;
            if (kind) filter.kind = kind;
            if (entityId) filter.entity_id = entityId;

            ws.send(JSON.stringify({ type: 'subscribe', filter }));
        }

        function unsubscribe(subId) {
            ws.send(JSON.stringify({ type: 'unsubscribe', subscription_id: subId }));
        }

        function sendPing() {
            ws.send(JSON.stringify({ type: 'ping' }));
        }

        function formatFilter(filter) {
            const parts = [];
            if (filter.entity_type) parts.push('entity_type=' + filter.entity_type);
            if (filter.event_type) parts.push('event_type=' + filter.event_type);
            if (filter.kind) parts.push('kind=' + filter.kind);
            if (filter.entity_id) parts.push('id=' + filter.entity_id.substring(0, 8) + '...');
            return parts.length > 0 ? '(' + parts.join(', ') + ')' : '(all events)';
        }

        function renderSubscriptions() {
            const list = document.getElementById('subscriptions-list');
            const keys = Object.keys(subscriptions);
            document.getElementById('sub-count').textContent = '(' + keys.length + ')';

            if (keys.length === 0) {
                list.innerHTML = '<div style="color: #666; font-size: 0.85em;">No active subscriptions</div>';
                return;
            }

            list.innerHTML = keys.map(id => {
                const filter = subscriptions[id];
                return '<div class="subscription-item">' +
                    '<span class="filter-info">' + formatFilter(filter) + '</span>' +
                    '<button class="danger" onclick="unsubscribe(\'' + id + '\')">Unsub</button>' +
                    '</div>';
            }).join('');
        }

        function logEntry(type, text, data) {
            const log = document.getElementById('event-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;

            const now = new Date().toLocaleTimeString();
            let html = '<span class="timestamp">[' + now + ']</span> ' + text;
            if (data) {
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            }
            entry.innerHTML = html;

            log.insertBefore(entry, log.firstChild);
        }

        function logSystem(text) {
            logEntry('system', text);
        }

        function clearLog() {
            document.getElementById('event-log').innerHTML = '';
            eventCount = 0;
            document.getElementById('event-count').textContent = '(0 events)';
        }

        function setStatus(state) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const btn = document.getElementById('btn-connect');

            dot.className = 'status-dot ' + state;
            text.textContent = state.charAt(0).toUpperCase() + state.slice(1);
            btn.textContent = state === 'connected' ? 'Disconnect' : 'Connect';
        }

        // Initialize
        renderSubscriptions();
    </script>
</body>
</html>
